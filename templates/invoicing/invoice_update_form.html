{% extends 'invoicing/base.html' %}

{% load static %}

{% block title %}Edit Invoice #{{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">Edit Invoice #{{ invoice.invoice_number }}</h1>
                    <p class="text-gray-600 mt-2">Update invoice details and items</p>
                </div>
                <a href="{% url 'invoicing:invoice_detail' invoice.pk %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Invoice
                </a>
            </div>
        </div>

        <!-- Invoice Status Alert -->
        {% if invoice.status == 'PAID' %}
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-yellow-600 mr-3"></i>
                <div>
                    <h3 class="text-sm font-medium text-yellow-800">Paid Invoice</h3>
                    <p class="text-sm text-yellow-700 mt-1">This invoice has been fully paid. Editing may affect payment records.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Form -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <form method="post" id="invoice-form">
                {% csrf_token %}
                
                <!-- Customer and Basic Info -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="{{ form.customer.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Customer <span class="text-red-500">*</span>
                        </label>
                        {{ form.customer }}
                        {% if form.customer.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.customer.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.issue_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Issue Date <span class="text-red-500">*</span>
                        </label>
                        {{ form.issue_date }}
                        {% if form.issue_date.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.issue_date.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="{{ form.due_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Due Date <span class="text-red-500">*</span>
                        </label>
                        {{ form.due_date }}
                        {% if form.due_date.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.due_date.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Status
                        </label>
                        {{ form.status }}
                        {% if form.status.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.status.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Tax Settings -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="{{ form.tax_rate.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Tax Rate (%)
                        </label>
                        {{ form.tax_rate }}
                        {% if form.tax_rate.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.tax_rate.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <label for="{{ form.discount_amount.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Discount Amount
                        </label>
                        {{ form.discount_amount }}
                        {% if form.discount_amount.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.discount_amount.errors }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="{{ form.payment_terms.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            Payment Terms
                        </label>
                        {{ form.payment_terms }}
                        {% if form.payment_terms.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.payment_terms.errors }}</div>
                        {% endif %}
                    </div>
                    
                    <div>
                        <!-- Empty cell for grid balance -->
                    </div>
                </div>

                <!-- Notes -->
                <div class="mb-6">
                    <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Notes
                    </label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.notes.errors }}</div>
                    {% endif %}
                </div>

                <!-- Existing Invoice Items -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Invoice Items</h3>
                        <button type="button" id="add-item-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                            <i class="fas fa-plus mr-2"></i>Add Item
                        </button>
                    </div>
                    
                    <div id="items-container" class="space-y-4">
                        <!-- Existing items -->
                        {% for item in invoice.items.all %}
                        <div class="item-row border rounded-lg p-4 bg-gray-50">
                            <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                                    <select name="item_product[]" class="product-select w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <option value="">Select a product...</option>
                                        {% for product in products %}
                                        <option value="{{ product.id }}" data-price="{{ product.selling_price }}" data-name="{{ product.name }}" {% if item.product and item.product.id == product.id %}selected{% endif %}>
                                            {{ product.name }} (Stock: {{ product.stock_quantity }})
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <input type="hidden" name="item_id[]" value="{{ item.id }}">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                    <input type="text" name="item_description[]" value="{{ item.description }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                    <input type="number" name="item_quantity[]" value="{{ item.quantity }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                                    <input type="number" name="item_unit_price[]" value="{{ item.unit_price }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" step="0.01" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Discount (%)</label>
                                    <input type="number" name="item_discount[]" value="{{ item.discount_rate }}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" max="100">
                                </div>
                                <div class="flex items-end">
                                    <button type="button" class="remove-item-btn bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition-colors">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Summary -->
                <div class="border-t pt-6">
                    <div class="flex justify-end">
                        <div class="w-full md:w-1/2">
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Subtotal:</span>
                                    <span id="subtotal" class="font-medium">KES {{ invoice.subtotal|floatformat:2 }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Tax:</span>
                                    <span id="tax-amount" class="font-medium">KES {{ invoice.tax_amount|floatformat:2 }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Discount:</span>
                                    <span id="discount-amount" class="font-medium">KES {{ invoice.discount_amount|floatformat:2 }}</span>
                                </div>
                                <div class="flex justify-between text-lg font-bold border-t pt-2">
                                    <span>Total:</span>
                                    <span id="total-amount">KES {{ invoice.total_amount|floatformat:2 }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4 mt-8">
                    <a href="{% url 'invoicing:invoice_detail' invoice.pk %}" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-300 transition-colors">
                        Cancel
                    </a>
                    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Update Invoice
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Item Template (Hidden) -->
<template id="item-template">
    <div class="item-row border rounded-lg p-4 bg-gray-50">
        <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Product</label>
                <select name="item_product[]" class="product-select w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Select a product...</option>
                    {% for product in products %}
                    <option value="{{ product.id }}" data-price="{{ product.selling_price }}" data-name="{{ product.name }}">
                        {{ product.name }} (Stock: {{ product.stock_quantity }})
                    </option>
                    {% endfor %}
                </select>
                <input type="hidden" name="item_id[]" value="">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <input type="text" name="item_description[]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                <input type="number" name="item_quantity[]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="1" value="1" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Unit Price</label>
                <input type="number" name="item_unit_price[]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" step="0.01" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Discount (%)</label>
                <input type="number" name="item_discount[]" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" min="0" max="100" value="0">
            </div>
            <div class="flex items-end">
                <button type="button" class="remove-item-btn bg-red-500 text-white px-3 py-2 rounded-md hover:bg-red-600 transition-colors">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add item button handler
    document.getElementById('add-item-btn').addEventListener('click', addItem);
    
    function addItem() {
        const template = document.getElementById('item-template');
        const clone = template.content.cloneNode(true);
        const container = document.getElementById('items-container');
        
        // Add event listener to remove button
        const removeBtn = clone.querySelector('.remove-item-btn');
        removeBtn.addEventListener('click', function() {
            this.closest('.item-row').remove();
            updateTotals();
        });
        
        // Add event listener to product select
        const productSelect = clone.querySelector('.product-select');
        productSelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const descriptionInput = this.closest('.item-row').querySelector('input[name="item_description[]"]');
            const priceInput = this.closest('.item-row').querySelector('input[name="item_unit_price[]"]');
            
            if (selectedOption.value) {
                descriptionInput.value = selectedOption.dataset.name;
                priceInput.value = selectedOption.dataset.price;
            } else {
                descriptionInput.value = '';
                priceInput.value = '';
            }
            updateTotals();
        });
        
        // Add change listeners to all inputs
        const inputs = clone.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', updateTotals);
        });
        
        container.appendChild(clone);
        updateTotals();
    }
    
    // Add event listeners to existing items
    document.querySelectorAll('.item-row').forEach(row => {
        const removeBtn = row.querySelector('.remove-item-btn');
        if (removeBtn) {
            removeBtn.addEventListener('click', function() {
                this.closest('.item-row').remove();
                updateTotals();
            });
        }
        
        // Add event listener to product select for existing items
        const productSelect = row.querySelector('.product-select');
        if (productSelect) {
            productSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const descriptionInput = this.closest('.item-row').querySelector('input[name="item_description[]"]');
                const priceInput = this.closest('.item-row').querySelector('input[name="item_unit_price[]"]');
                
                if (selectedOption.value) {
                    descriptionInput.value = selectedOption.dataset.name;
                    priceInput.value = selectedOption.dataset.price;
                } else {
                    descriptionInput.value = '';
                    priceInput.value = '';
                }
                updateTotals();
            });
        }
        
        const inputs = row.querySelectorAll('input');
        inputs.forEach(input => {
            input.addEventListener('input', updateTotals);
        });
    });
    
    function updateTotals() {
        const items = document.querySelectorAll('.item-row');
        let subtotal = 0;
        
        items.forEach(item => {
            const quantity = parseFloat(item.querySelector('input[name="item_quantity[]"]').value) || 0;
            const unitPrice = parseFloat(item.querySelector('input[name="item_unit_price[]"]').value) || 0;
            const discount = parseFloat(item.querySelector('input[name="item_discount[]"]').value) || 0;
            
            const itemTotal = quantity * unitPrice;
            const discountAmount = itemTotal * (discount / 100);
            subtotal += itemTotal - discountAmount;
        });
        
        const taxRate = parseFloat(document.getElementById('{{ form.tax_rate.id_for_label }}').value) || 0;
        const discountAmount = parseFloat(document.getElementById('{{ form.discount_amount.id_for_label }}').value) || 0;
        
        const taxAmount = subtotal * (taxRate / 100);
        const total = subtotal + taxAmount - discountAmount;
        
        document.getElementById('subtotal').textContent = `KES ${subtotal.toFixed(2)}`;
        document.getElementById('tax-amount').textContent = `KES ${taxAmount.toFixed(2)}`;
        document.getElementById('discount-amount').textContent = `KES ${discountAmount.toFixed(2)}`;
        document.getElementById('total-amount').textContent = `KES ${total.toFixed(2)}`;
    }
    
    // Update totals when tax or discount amounts change
    document.getElementById('{{ form.tax_rate.id_for_label }}').addEventListener('input', updateTotals);
    document.getElementById('{{ form.discount_amount.id_for_label }}').addEventListener('input', updateTotals);
    
    // Form styling
    const formInputs = document.querySelectorAll('input, select, textarea');
    formInputs.forEach(input => {
        if (!input.classList.contains('form-control')) {
            input.classList.add('w-full', 'px-3', 'py-2', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500');
        }
    });
    
    // Date inputs
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
        input.classList.add('block');
    });
    
    // Initialize totals
    updateTotals();
});
</script>
{% endblock %}
